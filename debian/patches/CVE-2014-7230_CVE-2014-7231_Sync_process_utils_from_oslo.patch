Description: Sync process utils from oslo
 This patch backports the missing change to fix ssh_execute password leak. The
 sync pulls in the following changes:
 .
 105169f8 - Mask passwords in exceptions and error messages (SSH)
Author: Tristan Cacqueray <tristan.cacqueray@enovance.com>
Date: Tue, 7 Oct 2014 19:36:07 +0000 (+0000)
X-Git-Url: https://review.openstack.org/gitweb?p=openstack%2Fnova.git;a=commitdiff_plain;h=56b62b79a75624305858c10a5f285b08374b7506
Bug-Ubuntu: https://launchpad.net/bugs/1377981
Bug-Debian: https://bugs.debian.org/765714
Change-Id: Ie0caf32469126dd9feb44867adf27acb6e383958
Origin: upstream, https://review.openstack.org/#/c/126699/
Last-Update: 2014-10-17

diff --git a/nova/openstack/common/processutils.py b/nova/openstack/common/processutils.py
index 9d4e0d3..cb787e2 100644
--- a/nova/openstack/common/processutils.py
+++ b/nova/openstack/common/processutils.py
@@ -237,7 +237,8 @@ def trycmd(*args, **kwargs):
 
 def ssh_execute(ssh, cmd, process_input=None,
                 addl_env=None, check_exit_code=True):
-    LOG.debug(_('Running cmd (SSH): %s'), cmd)
+    sanitized_cmd = strutils.mask_password(cmd)
+    LOG.debug(_('Running cmd (SSH): %s'), sanitized_cmd)
     if addl_env:
         raise InvalidArgumentError(_('Environment not supported over SSH'))
 
@@ -251,7 +252,10 @@ def ssh_execute(ssh, cmd, process_input=None,
     # NOTE(justinsb): This seems suspicious...
     # ...other SSH clients have buffering issues with this approach
     stdout = stdout_stream.read()
+    sanitized_stdout = strutils.mask_password(stdout)
     stderr = stderr_stream.read()
+    sanitized_stderr = strutils.mask_password(stderr)
+
     stdin_stream.close()
 
     exit_status = channel.recv_exit_status()
@@ -261,8 +265,8 @@ def ssh_execute(ssh, cmd, process_input=None,
         LOG.debug(_('Result was %s') % exit_status)
         if check_exit_code and exit_status != 0:
             raise ProcessExecutionError(exit_code=exit_status,
-                                        stdout=stdout,
-                                        stderr=stderr,
-                                        cmd=cmd)
+                                        stdout=sanitized_stdout,
+                                        stderr=sanitized_stderr,
+                                        cmd=sanitized_cmd)
 
-    return (stdout, stderr)
+    return (sanitized_stdout, sanitized_stderr)
